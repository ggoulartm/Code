
#include "./Client/CL_include.h"
#include "./Client/redacteur.h"
#include "./Client/lecteur.h"
#include "CL_Connection.h"


void litbuf1();
void litbuf2();
int voie;			/*variable globale (numero du canal a lire)*/


int Lecteur(Connection conn, int nb_iteration, pthread_t thread1); //Run the reader thread for nb_iteration
int Redacteur(Connection conn, int nb_iteration, pthread_t thread2); //Run the writer thread for nb_iteration

int main(int argc, char *argv[])
{
	  /* ... */

	  if(argc < 2) {
		printf("!!!! Usage : Client  <+/-nombre de donnees>\n");
		return 1;
	  }


	signal(SIGUSR1, litbuf1);
	signal(SIGUSR2, litbuf2);

	int nb_iteration = atoi(argv[1]);

	printf("\n* * * * * * * * * * * * * * * * * * * * * * * * *\n");
	printf("Projet CLIENT - SERVEUR\tTemps RÃ©el E2i - Novembre\n");
	printf("* * * * * * * * * * * * * * * * * * * * * * * * *\n");
	printf("\nLancement du client pendant %d secondes\n", nb_iteration);
	

	Connection errConn = Connect();
	printf("Connection SUCCESS: %d\n",errConn.err);

	pthread_t lecteur1, reader1;

	//Lecteur 1
	//Run the reader thread for nb_iteration
	int err_ = Lecteur(errConn, nb_iteration, lecteur1);
	if (err_ != 0) {
		pthread_exit(NULL);
		Deconnect();
		return err_;
	}

	//Redacteur 1
	//Run the redactor thread for nb_iteration
	err_ = Redacteur(errConn, nb_iteration, reader1);
		if (err_ != 0) {
		pthread_exit(NULL);
		Deconnect();
		return err_;
	}

		pthread_t lecteur2, reader2;

	//Lecteur 2
	//Run the reader thread for nb_iteration
	err_ = Lecteur(errConn, nb_iteration, lecteur2);
	if (err_ != 0) {
		pthread_exit(NULL);
		Deconnect();
		return err_;
	}

	//Redacteur 2
	//Run the redactor thread for nb_iteration
	err_ = Redacteur(errConn, nb_iteration, reader2);
		if (err_ != 0) {
		pthread_exit(NULL);
		Deconnect();
		return err_;
	}

	//Wait for the threads to finish
	pthread_join(lecteur1, NULL);
  	pthread_join(reader1, NULL);		
	pthread_join(lecteur2, NULL);
  	pthread_join(reader2, NULL);

	//Exit the thread
	//Don't forget to deconnect the client
	pthread_exit(NULL);

return Deconnect();
}	   	   

	   	   	   
/*/////////////////////////////////////////////////////////////////////////*/
	   
void litbuf1() /* semaphore 0 */
{
	voie=0;
	signal(SIGUSR1,litbuf1);
}


/*/////////////////////////////////////////////////////////////////////////*/

void litbuf2()
{
	voie=1;	
	signal(SIGUSR2,litbuf2);
}

//Run the reader thread for nb_iteration
int Lecteur(Connection conn, int nb_iteration, pthread_t thread1){
	int err;
	err = pthread_create(&thread1, NULL, Lecteur_Start, (void*)conn.key);
	if(err != 0){
		printf("Error creating the thread\n");
		return 1;
	}
	return 0;
}

//Run the redactor thread for nb_iteration
int Redacteur(Connection conn, int nb_iteration, pthread_t thread2){
	int err;
	err = pthread_create(&thread2, NULL, Redacteur_Start, (void*)conn.key);
	if(err != 0){
		printf("Error creating the thread\n");
		return 1;
	}
	return 0;
}
