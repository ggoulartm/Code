
#include "./Client/CL_include.h"
#include "CL_Connection.h"


void litbuf1();
void litbuf2();

int pipe_fd1[2];
int pipe_fd2[2];
int* pipe_fd[2];

int main(int argc, char *argv[])
{
	  /* ... */
	int nb_iteration = 100;
	  if(argc < 2) {
		printf("!!!! Usage : Client  <+/-nombre de donnees>\n");
		//return -1;
	  } else {
		nb_iteration = atoi(argv[1]);
	  }

	// Signal handling
	signal(SIGUSR1, litbuf1);
	signal(SIGUSR2, litbuf2);
	signal(SIGTERM, Disconnect);

	// Create the pipe
	pipe(pipe_fd1);
	pipe(pipe_fd2);
	pipe_fd[0] = pipe_fd1;
	pipe_fd[1] = pipe_fd2;

	printf("\n* * * * * * * * * * * * * * * * * * * * * * * * *\n");
	printf("Projet CLIENT - SERVEUR\tTemps RÃ©el E2i - Novembre\n");
	printf("* * * * * * * * * * * * * * * * * * * * * * * * *\n");
	printf("\nLancement du client pendant %d secondes\n", nb_iteration);
	
	// Connection to the server
	Connection errConn = Connect();
	printf("Connection SUCCESS: %d\n",errConn.err);
	
	while(nb_iteration > 0){
		sleep(1);
		nb_iteration--;
		// Wait for the server to send a signal
	}

return Deconnect();
}	   	   


//Run the reader thread for nb_iteration
int Lecteur(int voie){
	char* key = "/tmp/CleClt";
	key_t cle = CreationKey(key);
	//shmget
    int CLTshmid = shmget(cle,2*sizeof(BUF),0666|IPC_CREAT);
	if (CLTshmid == -1) {
        perror("shmget");
        exit(1);
    }
    //shmat
    BUF *MemTamponPtr = (BUF *)shmat(CLTshmid,NULL,0);
	if (MemTamponPtr == (void *)-1) {
        perror("shmat");
        exit(1);
    }
	//printf("Lecture de la voie 0, Cle: %d\n", cle);
	int index = (MemTamponPtr+voie)->n;
	int data = (MemTamponPtr+voie)->tampon[index];
	//printf("Adresse %p, Data: %d, Index: %d\n", MemTamponPtr,data,index);
	if (shmdt(MemTamponPtr) == -1) {
		perror("shmdt");
		exit(1);
	}
	write(pipe_fd[voie][1], &data, sizeof(int));
	return  data;
}

//Run the redactor thread for nb_iteration
void Redacteur(int voie){
	static int times[2];
	static int buffer1[5];
	static int buffer2[5];
	int* buffer[2];
	buffer[0] = buffer1;
	buffer[1] = buffer2;

		read(pipe_fd[voie][0], &buffer[voie][times[voie]], sizeof(int));
		times[voie]++;
		if(times[voie] == 5){
			for(int i = 0; i < 5; i++){
				printf("Data: %d, Voie: %d\n", buffer[voie][i],voie);
			}
			times[voie] = 0;
		}
}

	   	   	   
/*/////////////////////////////////////////////////////////////////////////*/
	   
void litbuf1() /* semaphore 0 */
{
	signal(SIGUSR1,litbuf1);
	printf("Signal recu par le main voie 0\n");

	int voie = 0;
	Lecteur(voie);
	Redacteur(voie);
	
}


/*/////////////////////////////////////////////////////////////////////////*/

void litbuf2()
{	
	signal(SIGUSR2,litbuf2);
	printf("Signal recu par le main voie 1\n");

	int voie = 1;
	Lecteur(voie);
	Redacteur(voie);
}