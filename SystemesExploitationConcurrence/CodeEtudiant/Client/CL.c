
#include "./Client/CL_include.h"
#include "CL_Connection.h"
#include "./Client/lecteur.h"
#include "./Client/redacteur.h"

void litbuf1();
void litbuf2();
void signal_handler0();
void signal_handler1();

int pipeCh1[2];
int pipeCh2[2];
int* tubeEnsemble[2];

int voie;
int pid0 , pid1;

Connection errConn;

int main(int argc, char *argv[])
{
	// Number of iterations - time
	int nb_iteration = 100;
	  if(argc < 2) {
		printf("!!!! Usage : Client  <+/-nombre de donnees>\nAssuming 100 secondes\n");
		//return -1;
	  } else {
		nb_iteration = atoi(argv[1]);
	  }



	// Create the pipe
	pipe(pipeCh1);
	pipe(pipeCh2);
	tubeEnsemble[0] = pipeCh1; //mettre le tube du canal 1 dans le tableau de tube
	tubeEnsemble[1] = pipeCh2; //mettre le tube du canal 2 dans le tableau de tube

	// Print the header of the Client
	printf("\n* * * * * * * * * * * * * * * * * * * * * * * * *\n");
	printf("Projet CLIENT - SERVEUR\tTemps RÃ©el E2i - Novembre\n");
	printf("* * * * * * * * * * * * * * * * * * * * * * * * *\n");
	printf("\nLancement du client pendant %d secondes\n", nb_iteration);
	
	// Connection to the server
	errConn = Connect();
	printf("Connection SUCCESS: %d\n",errConn.err);

	// Create the child process channel 0
	pid0 = fork();
	if (pid0 == 0) { // Child ch 0 - Lecteur/Redacteur voie 0
		voie = 0;
        printf("Lancement Channel 0\n");
		signal(SIGUSR1, litbuf1);
    } else { // Parent
        close(tubeEnsemble[0][0]); // Close read end
		close(tubeEnsemble[0][1]); // Close write end
	
		// Create the Channel process channel 1
		pid1 = fork();
		if (pid1 == 0) { // Channel ch 1 - Lecteur/Redacteur voie 1
			voie = 1;
			printf("Lancement Channel 1 \n");
			signal(SIGUSR2, litbuf2);
		} else { // Parent
		    close(tubeEnsemble[1][0]); // Close read end
			close(tubeEnsemble[1][1]); // Close write end
			
			// Signal handling
			signal(SIGTERM, Disconnect);
			signal(SIGINT, Disconnect);
			signal(SIGUSR1, signal_handler0);
			signal(SIGUSR2, signal_handler1);

				// Wait for the time to pass and disconnect
			while(nb_iteration > 0){
				sleep(1);
				nb_iteration--;
				// Wait for the server to send a signal
			}

			return Deconnect();
		}
    }

	
	// Wait for the time to pass and disconnect
	while(nb_iteration > 0){
		sleep(1);
		nb_iteration--;
		// Wait for the server to send a signal
	}

return 0;
}	   	   


// Signal handling from the lecteur and redacteur processes
	   	   	   
/*/////////////////////////////////////////////////////////////////////////*/
	   
void litbuf1() /* semaphore 0 */
{
	// Signal handling
	if(voie == 1) return;
	signal(SIGUSR1,litbuf1);
	//printf("Signal recu par le main voie 0\n");

	// Run the reader and the writer
	Lecteur(voie,tubeEnsemble,errConn.key);
	Redacteur(voie,tubeEnsemble);
	
}


void litbuf2() /* semaphore 1 */
{	
	if(voie == 0) return;

	// Signal handling
	signal(SIGUSR2,litbuf2);
	//printf("Signal recu par le main voie 1\n");

	// Run the reader and the writer
	Lecteur(voie,tubeEnsemble,errConn.key);
	Redacteur(voie,tubeEnsemble);
}

// Signal handling from moniteur process
// talk to the lecteur of channel 0 when the signal is received
void signal_handler0() {
	signal(SIGUSR1, signal_handler0);
	kill(pid0,SIGUSR1);
}

// talk to the lecteur of channel 1 when the signal is received
void signal_handler1() {
	signal(SIGUSR2, signal_handler1);
	kill(pid1,SIGUSR2);
}