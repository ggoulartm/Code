#include "CL_Connection.h"

// This is a function that creates a key
// The function takes a key as a parameter
// The function returns the proper key
key_t CreationKey(char *Cle){
	key_t key;
	if(Cle == NULL) {
		if (( key = ftok(CleServeur,C_Msg)) < 0 ) return CLEerr;
	}
	else {
		//We can use also 'C' as int entry in the ftok function, 
		//I don't know why the author of the server used sometimes 'C' or 'T'
		if (( key = ftok(Cle,C_Shm)) < 0 ) return CLEerr;
	}
	return key;
}

// This is a function that creates a message queue
// The function takes a key as a parameter
// The function returns the message queue ID
// The function uses the msgget function to create a message queue as the server does
int CreationMessagerie(char *Cle){
	key_t key = CreationKey(Cle);
	return msgget(key,0666|IPC_CREAT);
}


//Connect send to the server the PID of the client
//with the type CONNECT and just after send the ACK
//Return 0 if the message is sent, -1 otherwise
Connection Connect(){
	dmsgbuf message;
	pid_t ClientPID = getpid();    
	printf("Connect Client PID: %d\n", ClientPID);
	pid_t msqid = CreationMessagerie(NULL);
	message.type=CONNECT;
	sprintf(message.txt,  "%d", ClientPID);
	msgsnd(msqid,&message,L_MSG,IPC_NOWAIT);
	message.type=ClientPID;
	msgrcv(msqid,&message,L_MSG,message.type,0);
	printf("Message (type: %ld) Reçu do Serveur: %s\n", message.type,message.txt);
	//Connection Instance
	Connection conn;
	conn.pid = ClientPID;
	conn.msqid = msqid;
	conn.key = CreationKey(message.txt);
	////////////////////////////
	//////apres reception de la cle du serveur
	message.type=ACK;
	sprintf(message.txt,  "%d", ClientPID);
	conn.err = msgsnd(msqid,&message,L_MSG,IPC_NOWAIT);
	printf("Message (type: %ld) Reçu do Serveur: %s\n", message.type,message.txt);
	return conn;
}

//Deconnect send to the server the PID of the client and type DECONNECT
int Deconnect() {
	pid_t ClientPID = getpid();  
	printf("Disconnecting Client PID: %d\n", ClientPID);
	pid_t MsqID = CreationMessagerie(NULL);
	dmsgbuf message;
	message.type=DECONNECT;
	sprintf(message.txt,  "%d", ClientPID);
	return msgsnd(MsqID,&message,L_MSG,IPC_NOWAIT);
}

//Disconnect send to the server the PID of the client and type DECONNECT
//this function exists because the signal handler can't return a value
void Disconnect() {
	exit(Deconnect());
}