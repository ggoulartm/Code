#include "lecteur.h"

#define BUFFER_SIZE 1024

BUF *MemTamponPtr = NULL;
int voieLecteur=0;
int* tubeLecteur;

void readVoie() {
    //The process is blocked until the semaphore is unlocked
    //read from the buffer and writing in the tubeLecteur;
    int donne = (MemTamponPtr+voieLecteur)->tampon[(MemTamponPtr+voieLecteur)->n];
    printf("Donn√©: %d\n", donne);
    write(tubeLecteur, &donne, 1);
    signal(SIGUSR1+voieLecteur, readVoie);
}

void CreateMemPartag(key_t cle) {
    //shmget
    int CLTshmid = shmget(cle,2*sizeof(BUF),0644|IPC_CREAT);
    //shmat
    MemTamponPtr = (BUF *)shmat(CLTshmid,NULL,0);
}

void Lecteur_Start(key_t key, void* tubeMoniteur) {
    printf("Lecteur Start - waiting for pipe from moniteur\n");
    read(tubeMoniteur, &voieLecteur, sizeof(int));
    printf("Lecteur %d Start\n", voieLecteur);
    tubeLecteur = malloc(sizeof(int));
    tubeLecteur = tubeMoniteur++;
    CreateMemPartag(key);
    signal(SIGUSR1+voieLecteur, readVoie);
}