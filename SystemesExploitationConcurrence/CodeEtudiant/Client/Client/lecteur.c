#include "lecteur.h"

//Run the reader thread for nb_iteration
int Lecteur(int voie, int* pipe_fd[], key_t cle){
	//shmget: get the shared memory
    int CLTshmid = shmget(cle,2*sizeof(BUF),0666|IPC_CREAT);
	if (CLTshmid == -1) {
        perror("shmget");
        exit(1);
    }
    //shmat: attach the shared memory
    BUF *MemTamponPtr = (BUF *)shmat(CLTshmid,NULL,0);
	if (MemTamponPtr == (void *)-1) {
        perror("shmat");
        exit(1);
    }

	//printf("Lecture de la voie 0, Cle: %d\n", cle);
	// Get the data from the shared memory
	int index = (MemTamponPtr+voie)->n;
	int data = (MemTamponPtr+voie)->tampon[index];
	//printf("Adresse %p, Data: %d, Index: %d\n", MemTamponPtr,data,index);

	//shmdt: detach the shared memory
	if (shmdt(MemTamponPtr) == -1) {
		perror("shmdt");
		exit(1);
	}

	// Write the data to the writer
	write(pipe_fd[voie][1], &data, sizeof(int));
	return  data;
}