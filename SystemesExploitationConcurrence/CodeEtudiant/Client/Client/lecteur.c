#include "lecteur.h"

#define BUFFER_SIZE 1024

BUF *MemTamponPtr = NULL;
int tube,voie;

void readVoie() {
    printf("Lecteur %d, message reÃ§u\n", voie);
    //The process is blocked until the semaphore is unlocked
    //read from the buffer and writing in the tube
    write(tube, (MemTamponPtr+voie)->tampon[(MemTamponPtr+voie)->n], sizeof(int));
    signal(SIGUSR1+voie, &readVoie);
}

void CreateMemPartag(key_t cle) {
    //shmget
    int CLTshmid = shmget(cle,2*sizeof(BUF),0644|IPC_CREAT);
    //shmat
    MemTamponPtr = (BUF *)shmat(CLTshmid,NULL,0);
}

void Lecteur_Start(key_t key, int tube_) {
    tube = tube_;
    read(tube, &voie, sizeof(int));
    printf("Lecteur %d Start\n", voie);
    CreateMemPartag((void*)key);
    signal(SIGUSR1+voie, &readVoie);
}